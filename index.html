<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>MimicNotes ‚Äî Notes That Think Like You</title>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=DM+Mono:ital,wght@0,300;0,400;1,300&family=Fraunces:ital,wght@0,300;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1410;
    --paper: #f5f0e8;
    --cream: #ede7d3;
    --amber: #d4841a;
    --rust: #c0392b;
    --sage: #5a7a5a;
    --blue: #2c5f8a;
    --shadow: rgba(26,20,16,0.15);
    --line: rgba(26,20,16,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    background-image: 
      repeating-linear-gradient(
        transparent,
        transparent 31px,
        var(--line) 31px,
        var(--line) 32px
      );
    background-attachment: fixed;
    overflow-x: hidden;
  }

  /* Paper texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.5;
  }

  /* Left margin red line */
  body::after {
    content: '';
    position: fixed;
    left: 72px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(192,57,43,0.3);
    pointer-events: none;
    z-index: 999;
  }

  header {
    padding: 32px 40px 24px 96px;
    border-bottom: 2px solid var(--line);
    position: relative;
  }

  .logo {
    font-family: 'Caveat', cursive;
    font-size: 42px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: -1px;
    line-height: 1;
  }

  .logo span { color: var(--amber); }

  .tagline {
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--ink);
    opacity: 0.5;
    margin-top: 4px;
  }

  .api-bar {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .api-bar input {
    background: var(--cream);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--ink);
    width: 280px;
    outline: none;
  }

  .api-bar input:focus { border-color: var(--amber); }
  .api-bar input::placeholder { opacity: 0.4; }

  .btn-save-key {
    background: var(--amber);
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: opacity 0.2s;
  }

  .btn-save-key:hover { opacity: 0.85; }

  main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: calc(100vh - 100px);
    align-items: start;
  }

  /* LEFT PANEL */
  .panel-left {
    padding: 40px 32px 40px 96px;
    border-right: 2px solid var(--line);
  }

  .panel-title {
    font-family: 'Fraunces', serif;
    font-size: 13px;
    font-weight: 300;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--amber);
    margin-bottom: 24px;
  }

  /* Upload zone */
  .upload-zone {
    border: 2px dashed rgba(26,20,16,0.25);
    border-radius: 8px;
    padding: 48px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(255,255,255,0.3);
    position: relative;
    margin-bottom: 24px;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--amber);
    background: rgba(212,132,26,0.06);
  }

  .upload-zone input[type="file"] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon {
    font-size: 48px;
    margin-bottom: 12px;
    display: block;
    opacity: 0.6;
  }

  .upload-zone h3 {
    font-family: 'Caveat', cursive;
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .upload-zone p {
    font-size: 11px;
    opacity: 0.5;
    letter-spacing: 0.05em;
  }

  /* Photo previews */
  .photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }

  .photo-thumb {
    position: relative;
    aspect-ratio: 4/3;
    border-radius: 4px;
    overflow: hidden;
    border: 2px solid var(--line);
    animation: fadeIn 0.3s ease;
  }

  .photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .photo-thumb .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    background: var(--rust);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  /* Topic input */
  .topic-section {
    margin-bottom: 24px;
  }

  .field-label {
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    opacity: 0.5;
    margin-bottom: 8px;
    display: block;
  }

  .topic-input {
    width: 100%;
    background: rgba(255,255,255,0.4);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 12px 16px;
    font-family: 'Caveat', cursive;
    font-size: 20px;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }

  .topic-input:focus { border-color: var(--amber); }
  .topic-input::placeholder { opacity: 0.3; }

  /* Style profile display */
  .style-profile {
    background: rgba(255,255,255,0.4);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    display: none;
  }

  .style-profile.visible { display: block; animation: fadeIn 0.4s ease; }

  .style-profile h4 {
    font-family: 'Fraunces', serif;
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--sage);
    margin-bottom: 12px;
  }

  .style-tag {
    display: inline-block;
    background: var(--cream);
    border: 1px solid var(--line);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 11px;
    margin: 3px;
    letter-spacing: 0.03em;
  }

  .style-tag.dominant {
    background: var(--amber);
    color: white;
    border-color: transparent;
  }

  /* Generate button */
  .btn-generate {
    width: 100%;
    background: var(--ink);
    color: var(--paper);
    border: none;
    padding: 16px;
    border-radius: 6px;
    font-family: 'Caveat', cursive;
    font-size: 22px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .btn-generate:hover { background: var(--amber); }
  .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-generate::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s;
  }

  .btn-generate:hover::after { transform: translateX(100%); }

  /* Step indicators */
  .steps {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    opacity: 0.4;
    transition: opacity 0.3s;
  }

  .step.active { opacity: 1; }
  .step.done { opacity: 0.7; color: var(--sage); }

  .step-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1.5px solid currentColor;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    flex-shrink: 0;
  }

  .step.done .step-dot { background: var(--sage); color: white; border-color: transparent; }
  .step.active .step-dot { border-color: var(--amber); color: var(--amber); }

  /* RIGHT PANEL */
  .panel-right {
    padding: 40px 40px 40px 32px;
    position: relative;
  }

  .output-area {
    min-height: 500px;
    position: relative;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    opacity: 0.3;
    text-align: center;
  }

  .empty-state .big-text {
    font-family: 'Caveat', cursive;
    font-size: 80px;
    line-height: 1;
    opacity: 0.3;
  }

  .empty-state p {
    font-size: 12px;
    letter-spacing: 0.08em;
    margin-top: 12px;
  }

  /* Generated notes */
  .notes-output {
    display: none;
    animation: fadeIn 0.5s ease;
  }

  .notes-output.visible { display: block; }

  .notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }

  .notes-title-display {
    font-family: 'Caveat', cursive;
    font-size: 32px;
    font-weight: 700;
    color: var(--ink);
  }

  .btn-copy {
    background: transparent;
    border: 1px solid var(--line);
    padding: 6px 14px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--ink);
  }

  .btn-copy:hover { border-color: var(--amber); color: var(--amber); }

  /* The rendered notes */
  .notes-content {
    font-family: 'Caveat', cursive;
    font-size: 20px;
    line-height: 1.8;
    color: var(--ink);
  }

  .notes-content h1 {
    font-size: 36px;
    font-weight: 700;
    margin: 24px 0 12px;
    color: var(--blue);
    border-bottom: 2px solid var(--line);
    padding-bottom: 8px;
  }

  .notes-content h2 {
    font-size: 28px;
    font-weight: 600;
    margin: 20px 0 8px;
    color: var(--amber);
  }

  .notes-content h3 {
    font-size: 22px;
    font-weight: 600;
    margin: 16px 0 6px;
    color: var(--rust);
  }

  .notes-content p { margin-bottom: 12px; }

  .notes-content ul, .notes-content ol {
    padding-left: 24px;
    margin-bottom: 12px;
  }

  .notes-content li { margin-bottom: 6px; }

  .notes-content blockquote {
    border-left: 3px solid var(--amber);
    padding-left: 16px;
    font-style: italic;
    color: var(--sage);
    margin: 16px 0;
  }

  .notes-content .analogy {
    background: rgba(90,122,90,0.1);
    border: 1px solid rgba(90,122,90,0.2);
    border-radius: 6px;
    padding: 12px 16px;
    margin: 12px 0;
    font-style: italic;
  }

  .notes-content .highlight {
    background: rgba(212,132,26,0.2);
    padding: 2px 6px;
    border-radius: 3px;
  }

  .notes-content .diagram {
    background: rgba(255,255,255,0.5);
    border: 1.5px solid var(--line);
    border-radius: 8px;
    padding: 20px;
    margin: 16px 0;
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    white-space: pre-wrap;
    color: var(--sage);
  }

  /* Loading state */
  .loading-overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(245,240,232,0.85);
    align-items: center;
    justify-content: center;
    flex-direction: column;
    z-index: 10;
    backdrop-filter: blur(4px);
  }

  .loading-overlay.visible { display: flex; }

  .loading-pencil {
    font-size: 48px;
    animation: write 1.2s ease-in-out infinite;
  }

  .loading-text {
    font-family: 'Caveat', cursive;
    font-size: 24px;
    margin-top: 16px;
    animation: pulse 1.5s ease-in-out infinite;
  }

  .loading-sub {
    font-size: 11px;
    opacity: 0.5;
    margin-top: 6px;
    letter-spacing: 0.1em;
  }

  /* Progress bar */
  .progress-bar {
    width: 200px;
    height: 3px;
    background: var(--line);
    border-radius: 2px;
    margin-top: 16px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--amber);
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes write {
    0%, 100% { transform: rotate(-5deg) translateX(0); }
    50% { transform: rotate(5deg) translateX(8px); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
  }

  /* Mobile */
  @media (max-width: 768px) {
    body::after { left: 32px; }

    header {
      padding: 20px 16px 16px 48px;
    }

    .logo { font-size: 32px; }

    .api-bar {
      position: static;
      transform: none;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .api-bar input { width: 100%; }

    main {
      grid-template-columns: 1fr;
    }

    .panel-left {
      padding: 24px 16px 24px 48px;
      border-right: none;
      border-bottom: 2px solid var(--line);
    }

    .panel-right {
      padding: 24px 16px 24px 48px;
    }
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--ink);
    color: var(--paper);
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 9999;
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  .model-select {
    background: var(--cream);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 8px 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--ink);
    outline: none;
    cursor: pointer;
  }

  /* Stats & Insights */
  .stats-panel {
    background: rgba(255,255,255,0.4);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
  }

  .stats-panel h4 {
    font-family: 'Fraunces', serif;
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--blue);
    margin-bottom: 14px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .stat-item {
    background: var(--cream);
    border-radius: 6px;
    padding: 10px 12px;
    border: 1px solid var(--line);
  }

  .stat-label {
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    opacity: 0.5;
    display: block;
    margin-bottom: 4px;
  }

  .stat-value {
    font-family: 'Caveat', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--ink);
  }

  .stat-value.highlight-amber { color: var(--amber); }
  .stat-value.highlight-blue { color: var(--blue); }
  .stat-value.highlight-sage { color: var(--sage); }

  /* Bottom panel: library + study next */
  .bottom-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    padding: 32px 40px 40px 96px;
    border-top: 2px solid var(--line);
    grid-column: 1 / -1;
  }

  @media (max-width: 768px) {
    .bottom-panels {
      grid-template-columns: 1fr;
      padding: 24px 16px 32px 48px;
    }
  }

  .sub-panel-title {
    font-family: 'Fraunces', serif;
    font-size: 12px;
    font-weight: 300;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--rust);
    margin-bottom: 16px;
  }

  /* Library */
  .library-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 260px;
    overflow-y: auto;
  }

  .library-item {
    background: rgba(255,255,255,0.5);
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    transition: border-color 0.2s;
    cursor: default;
  }

  .library-item:hover { border-color: var(--amber); }

  .library-item-title {
    font-family: 'Caveat', cursive;
    font-size: 17px;
    font-weight: 600;
    flex: 1;
  }

  .library-item-meta {
    font-size: 10px;
    opacity: 0.4;
    letter-spacing: 0.05em;
    margin-left: 10px;
    white-space: nowrap;
  }

  .library-item-del {
    background: none;
    border: none;
    color: var(--rust);
    cursor: pointer;
    opacity: 0.4;
    font-size: 14px;
    padding: 0 4px;
    transition: opacity 0.2s;
    margin-left: 6px;
  }
  .library-item-del:hover { opacity: 1; }

  .library-empty {
    font-size: 12px;
    opacity: 0.35;
    font-style: italic;
    padding: 8px 0;
  }

  /* Study next */
  .study-next-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .study-card {
    background: rgba(255,255,255,0.5);
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 12px 16px;
    animation: fadeIn 0.4s ease;
  }

  .study-card-topic {
    font-family: 'Caveat', cursive;
    font-size: 19px;
    font-weight: 700;
    color: var(--blue);
    margin-bottom: 4px;
  }

  .study-card-reason {
    font-size: 11px;
    opacity: 0.55;
    line-height: 1.5;
  }

  .btn-study-now {
    margin-top: 8px;
    background: none;
    border: 1px solid var(--blue);
    color: var(--blue);
    padding: 4px 12px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-study-now:hover { background: var(--blue); color: white; }

  .btn-refresh-suggestions {
    background: none;
    border: 1px solid var(--line);
    padding: 6px 14px;
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    cursor: pointer;
    color: var(--ink);
    transition: all 0.2s;
    margin-bottom: 14px;
    letter-spacing: 0.05em;
  }
  .btn-refresh-suggestions:hover { border-color: var(--amber); color: var(--amber); }
  .btn-refresh-suggestions:disabled { opacity: 0.4; cursor: not-allowed; }

  .study-loading {
    font-size: 12px;
    opacity: 0.45;
    font-style: italic;
    display: none;
  }
  .study-loading.visible { display: block; }
</style>
</head>
<body>

<header>
  <div class="logo">Mimic<span>Notes</span></div>
  <div class="tagline">Notes that think like you</div>
  <div class="api-bar">
    <input type="password" id="apiKeyInput" placeholder="sk-ant-... (your Anthropic API key)" />
    <select class="model-select" id="modelSelect">
      <option value="claude-opus-4-5">claude-opus-4-5</option>
      <option value="claude-sonnet-4-5" selected>claude-sonnet-4-5</option>
      <option value="claude-haiku-4-5">claude-haiku-4-5</option>
    </select>
    <button class="btn-save-key" onclick="saveKey()">Save</button>
  </div>
</header>

<main>
  <div class="panel-left">
    <div class="panel-title">01 ‚Äî Upload Your Notes</div>

    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-dot">1</div>
        <span>Upload photos</span>
      </div>
      <span style="opacity:0.2">‚Üí</span>
      <div class="step" id="step2">
        <div class="step-dot">2</div>
        <span>Analyze style</span>
      </div>
      <span style="opacity:0.2">‚Üí</span>
      <div class="step" id="step3">
        <div class="step-dot">3</div>
        <span>Generate notes</span>
      </div>
    </div>

    <div class="upload-zone" id="uploadZone">
      <input type="file" id="fileInput" accept="image/*" multiple capture="environment" />
      <span class="upload-icon">üì∑</span>
      <h3>Drop notes here or tap to photograph</h3>
      <p>JPG, PNG, HEIC ‚Äî multiple photos supported</p>
    </div>

    <div class="photo-grid" id="photoGrid"></div>

    <div class="style-profile" id="styleProfile">
      <h4>‚ú¶ Detected Style Profile</h4>
      <div id="styleTags"></div>
    </div>

    <div class="stats-panel" id="statsPanel" style="display:none">
      <h4>üìä Session Insights</h4>
      <div class="stats-grid" id="statsGrid"></div>
    </div>

    <div class="topic-section">
      <label class="field-label" for="topicInput">What topic should I take notes on?</label>
      <input type="text" class="topic-input" id="topicInput" placeholder="e.g. Photosynthesis, World War II, Calculus..." />
    </div>

    <button class="btn-generate" id="generateBtn" onclick="generate()">
      ‚úèÔ∏è Generate My Notes
    </button>
  </div>

  <div class="panel-right">
    <div class="panel-title">02 ‚Äî Your Personalized Notes</div>
    <div class="output-area">
      <div class="empty-state" id="emptyState">
        <div class="big-text">‚úé</div>
        <p>Upload your handwritten notes<br>to get started</p>
      </div>

      <div class="notes-output" id="notesOutput">
        <div class="notes-header">
          <div class="notes-title-display" id="notesTitleDisplay">Notes</div>
          <div style="display:flex;gap:8px">
            <button class="btn-copy" onclick="saveToLibrary()">Save ‚ú¶</button>
            <button class="btn-copy" onclick="copyNotes()">Copy ‚Üó</button>
          </div>
        </div>
        <div class="notes-content" id="notesContent"></div>
      </div>

      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-pencil">‚úèÔ∏è</div>
        <div class="loading-text" id="loadingText">Analyzing your style...</div>
        <div class="loading-sub" id="loadingSub">reading handwriting patterns</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="bottom-panels">
  <!-- Note Library -->
  <div>
    <div class="sub-panel-title">03 ‚Äî My Notes Library</div>
    <div class="library-list" id="libraryList">
      <div class="library-empty" id="libraryEmpty">No notes saved yet ‚Äî hit "Save ‚ú¶" after generating notes</div>
    </div>
  </div>

  <!-- What to Study Next -->
  <div>
    <div class="sub-panel-title">04 ‚Äî What to Study Next</div>
    <button class="btn-refresh-suggestions" id="refreshSuggestionsBtn" onclick="fetchStudySuggestions()">‚Üª Suggest topics</button>
    <div class="study-loading" id="studyLoading">‚ú¶ Thinking based on your library...</div>
    <div class="study-next-list" id="studyNextList">
      <div class="library-empty" id="studyEmpty">Save some notes to your library first, then ask for suggestions!</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_PROXY_URL = 'https://api.anthropic.com/v1/messages';
let uploadedImages = []; // {dataUrl, base64, mediaType}
let styleProfile = null;

// Load saved key ‚Äî handled in bottom load listener

function saveKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('mimicnotes_key', key);
  showToast('API key saved locally ‚úì');
}

function getKey() {
  return document.getElementById('apiKeyInput').value.trim();
}

function getModel() {
  return document.getElementById('modelSelect').value;
}

// File upload handling
const fileInput = document.getElementById('fileInput');
const uploadZone = document.getElementById('uploadZone');

fileInput.addEventListener('change', handleFiles);

uploadZone.addEventListener('dragover', e => {
  e.preventDefault();
  uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  handleFilesFromList(e.dataTransfer.files);
});

function handleFiles(e) {
  handleFilesFromList(e.target.files);
}

function handleFilesFromList(files) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const dataUrl = e.target.result;
      const base64 = dataUrl.split(',')[1];
      const mediaType = file.type;
      uploadedImages.push({ dataUrl, base64, mediaType });
      renderPhotoGrid();
      updateSteps();
      // Re-analyze style whenever photos change (reset existing profile)
      styleProfile = null;
      document.getElementById('styleProfile').classList.remove('visible');
      document.getElementById('step2').className = 'step';
      if (getKey()) {
        clearTimeout(window._analyzeDebounce);
        window._analyzeDebounce = setTimeout(analyzeStyle, 600);
      }
    };
    reader.readAsDataURL(file);
  });
}

function renderPhotoGrid() {
  const grid = document.getElementById('photoGrid');
  grid.innerHTML = uploadedImages.map((img, i) => `
    <div class="photo-thumb">
      <img src="${img.dataUrl}" alt="Note ${i+1}" />
      <button class="remove-btn" onclick="removePhoto(${i})">√ó</button>
    </div>
  `).join('');
}

function removePhoto(index) {
  uploadedImages.splice(index, 1);
  renderPhotoGrid();
  if (uploadedImages.length === 0) {
    styleProfile = null;
    document.getElementById('styleProfile').classList.remove('visible');
    document.getElementById('statsPanel').style.display = 'none';
    document.getElementById('step2').className = 'step';
  } else {
    // Re-analyze with remaining photos
    styleProfile = null;
    document.getElementById('styleProfile').classList.remove('visible');
    document.getElementById('step2').className = 'step';
    if (getKey()) {
      clearTimeout(window._analyzeDebounce);
      window._analyzeDebounce = setTimeout(analyzeStyle, 600);
    }
  }
}

function updateSteps() {
  if (uploadedImages.length > 0) {
    document.getElementById('step1').className = 'step done';
    document.getElementById('step1').querySelector('.step-dot').textContent = '‚úì';
  }
}

// Analyze handwriting style
async function analyzeStyle() {
  if (!getKey()) return;
  if (uploadedImages.length === 0) return;

  setLoadingState(true, 'Reading your style...', 'analyzing handwriting patterns', 30);

  try {
    const imageContent = uploadedImages.slice(0, 3).map(img => ({
      type: 'image',
      source: { type: 'base64', media_type: img.mediaType, data: img.base64 }
    }));

    const response = await callClaude([
      ...imageContent,
      {
        type: 'text',
        text: `Analyze these handwritten notes and extract the person's note-taking style profile. Return ONLY a JSON object with these exact fields:
{
  "noteStyle": one of ["bullet-heavy", "paragraph-heavy", "mixed", "outline", "cornell", "mind-map"],
  "visualElements": array of strings like ["diagrams", "arrows", "boxes", "highlights", "doodles", "symbols", "color-coding"],
  "writingDensity": one of ["sparse", "moderate", "dense"],
  "organizationPattern": one of ["hierarchical", "linear", "clustered", "flowing", "fragmented"],
  "emphasisStyle": array like ["underline", "caps", "circle", "box", "stars", "arrows"],
  "detailLevel": one of ["brief-keywords", "short-phrases", "full-sentences", "detailed-paragraphs"],
  "analogyUsage": one of ["none", "occasional", "frequent"],
  "colorUsage": one of ["monochrome", "minimal-color", "multi-color"],
  "abbreviations": one of ["none", "some", "heavy"],
  "personalFlair": string describing unique stylistic traits you notice,
  "dominantTrait": single most prominent characteristic for note-generation
}`
      }
    ]);

    const text = response.content[0].text;
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      styleProfile = JSON.parse(jsonMatch[0]);
      displayStyleProfile();
      document.getElementById('step2').className = 'step done';
      document.getElementById('step2').querySelector('.step-dot').textContent = '‚úì';
      document.getElementById('step3').className = 'step active';
    }
  } catch(e) {
    console.error('Style analysis error:', e);
    showToast('‚ö† Could not analyze style ‚Äî check your API key');
  }

  setLoadingState(false);
}

function displayStyleProfile() {
  if (!styleProfile) return;
  const container = document.getElementById('styleTags');
  const profile = styleProfile;

  const tags = [
    { label: profile.dominantTrait, dominant: true },
    { label: profile.noteStyle?.replace(/-/g, ' ') },
    { label: profile.detailLevel?.replace(/-/g, ' ') },
    ...(profile.visualElements || []).slice(0, 3).map(v => ({ label: v })),
    { label: profile.organizationPattern },
    { label: profile.analogyUsage !== 'none' ? `${profile.analogyUsage} analogies` : null },
  ].filter(t => t.label);

  container.innerHTML = tags.map(t =>
    `<span class="style-tag ${t.dominant ? 'dominant' : ''}">${t.label}</span>`
  ).join('');

  if (profile.personalFlair) {
    container.innerHTML += `<p style="font-size:12px;margin-top:12px;opacity:0.6;font-style:italic">"${profile.personalFlair}"</p>`;
  }

  document.getElementById('styleProfile').classList.add('visible');
  updateStatsPanel();
}

// Generate personalized notes
async function generate() {
  const key = getKey();
  if (!key) {
    showToast('‚ö† Please enter your Anthropic API key first');
    document.getElementById('apiKeyInput').focus();
    return;
  }

  const topic = document.getElementById('topicInput').value.trim();
  if (!topic) {
    showToast('‚ö† Please enter a topic first');
    document.getElementById('topicInput').focus();
    return;
  }

  if (uploadedImages.length === 0) {
    showToast('‚ö† Please upload at least one photo of your notes');
    return;
  }

  // Analyze style first if not done
  if (!styleProfile) {
    await analyzeStyle();
  }

  setLoadingState(true, 'Writing your notes...', 'mimicking your personal style', 60);

  const styleInstructions = buildStyleInstructions(styleProfile);

  try {
    const imageContent = uploadedImages.slice(0, 4).map(img => ({
      type: 'image',
      source: { type: 'base64', media_type: img.mediaType, data: img.base64 }
    }));

    const prompt = `You are a note-taking AI that perfectly mimics a student's personal note-taking style.

DETECTED STYLE PROFILE:
${JSON.stringify(styleProfile, null, 2)}

STYLE MIMICRY INSTRUCTIONS:
${styleInstructions}

TASK: Create comprehensive notes on the topic: "${topic}"

CRITICAL RULES:
1. Match the EXACT style patterns you see in the uploaded notes
2. Use the same level of detail, density, and organization
3. If they use lots of visuals/diagrams ‚Üí include ASCII diagrams and visual representations
4. If they write heavy paragraphs ‚Üí write full flowing explanations
5. If they use bullet points ‚Üí bullet everything
6. If they use analogies ‚Üí create clever analogies
7. Match their abbreviation patterns, emphasis styles, and personal quirks
8. Make this look like THEIR notes, not generic AI notes
9. Use markdown formatting: # for main headers, ## for subheaders, **bold** for emphasis, > for analogies/quotes, \`code\` for terms

Create the notes now. Be thorough and genuinely useful:`;

    const response = await callClaude([
      ...imageContent,
      { type: 'text', text: prompt }
    ]);

    const notesText = response.content[0].text;
    renderNotes(topic, notesText);

    document.getElementById('step3').className = 'step done';
    document.getElementById('step3').querySelector('.step-dot').textContent = '‚úì';

  } catch(e) {
    console.error('Generation error:', e);
    showToast('‚ö† Generation failed: ' + (e.message || 'Check console'));
  }

  setLoadingState(false);
}

function buildStyleInstructions(profile) {
  if (!profile) return 'Use a standard mixed note-taking style.';

  const instructions = [];

  if (profile.noteStyle === 'bullet-heavy') {
    instructions.push('Use bullet points for EVERYTHING. Minimal prose.');
  } else if (profile.noteStyle === 'paragraph-heavy') {
    instructions.push('Write in full flowing paragraphs. Avoid bullet points.');
  } else if (profile.noteStyle === 'cornell') {
    instructions.push('Structure as Cornell notes: main notes on right, key questions/terms on left (use a divider line), summary at bottom.');
  } else if (profile.noteStyle === 'mind-map') {
    instructions.push('Use hierarchical indentation and branches like a mind map. Show connections.');
  }

  if (profile.visualElements?.includes('diagrams')) {
    instructions.push('Include ASCII/text diagrams where helpful. Draw boxes, arrows, flowcharts using text characters.');
  }

  if (profile.detailLevel === 'brief-keywords') {
    instructions.push('Keep it SUPER concise. Keywords and short phrases only. No full sentences unless necessary.');
  } else if (profile.detailLevel === 'detailed-paragraphs') {
    instructions.push('Be VERY thorough and detailed. Write complete explanations like a textbook.');
  }

  if (profile.analogyUsage === 'frequent') {
    instructions.push('Use lots of analogies and real-world comparisons. Start explanations with "Think of it like..." or "It\'s basically like..." regularly.');
  } else if (profile.analogyUsage === 'occasional') {
    instructions.push('Include some helpful analogies for complex concepts.');
  }

  if (profile.abbreviations === 'heavy') {
    instructions.push('Use abbreviations heavily: w/ for with, b/c for because, ‚Üí for leads to, ‚à¥ for therefore, etc.');
  }

  if (profile.colorUsage === 'multi-color') {
    instructions.push('Use different header levels and formatting to suggest color-coding (the headers will render in different colors).');
  }

  if (profile.writingDensity === 'sparse') {
    instructions.push('Leave lots of white space. Keep content sparse and scannable.');
  } else if (profile.writingDensity === 'dense') {
    instructions.push('Pack in lots of information. Dense, information-rich content.');
  }

  if (profile.emphasisStyle?.includes('stars')) {
    instructions.push('Use ‚òÖ or * to mark important points.');
  }

  return instructions.join('\n') || 'Use a balanced, clear note-taking style.';
}

function renderNotes(topic, markdown) {
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('notesOutput').classList.add('visible');
  document.getElementById('notesTitleDisplay').textContent = topic;

  // Parse markdown to HTML
  let html = markdown
    .replace(/^# (.+)$/gm, '<h1>$1</h1>')
    .replace(/^## (.+)$/gm, '<h2>$1</h2>')
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g, '<strong class="highlight">$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^> (.+)$/gm, '<blockquote class="analogy">$1</blockquote>')
    .replace(/`([^`]+)`/g, '<code style="background:rgba(0,0,0,0.08);padding:2px 6px;border-radius:3px;font-family:DM Mono,monospace;font-size:0.85em">$1</code>')
    .replace(/^```([\s\S]*?)```/gm, '<div class="diagram">$1</div>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>\n?)+/g, m => `<ul>${m}</ul>`)
    .replace(/\n\n+/g, '</p><p>')
    .replace(/\n/g, '<br>');

  // Wrap non-tagged content in paragraphs
  html = '<p>' + html + '</p>';

  // Clean up empty paragraphs and bad nesting
  html = html
    .replace(/<p>(<h[123]>)/g, '$1')
    .replace(/(<\/h[123]>)<\/p>/g, '$1')
    .replace(/<p>(<ul>)/g, '$1')
    .replace(/(<\/ul>)<\/p>/g, '$1')
    .replace(/<p>(<blockquote)/g, '$1')
    .replace(/(<\/blockquote>)<\/p>/g, '$1')
    .replace(/<p>(<div class="diagram">)/g, '$1')
    .replace(/(<\/div>)<\/p>/g, '$1')
    .replace(/<p><\/p>/g, '')
    .replace(/<p><br><\/p>/g, '');

  document.getElementById('notesContent').innerHTML = html;
  // Refresh stats in case library count changed
  updateStatsPanel();
}

// API call
async function callClaude(contentArray) {
  const key = getKey();
  const model = getModel();

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': key,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: model,
      max_tokens: 4000,
      messages: [{ role: 'user', content: contentArray }]
    })
  });

  if (!response.ok) {
    const err = await response.json();
    throw new Error(err.error?.message || `API error ${response.status}`);
  }

  return response.json();
}

// UI helpers
function setLoadingState(visible, text, sub, progress) {
  const overlay = document.getElementById('loadingOverlay');
  const btn = document.getElementById('generateBtn');

  if (visible) {
    overlay.classList.add('visible');
    btn.disabled = true;
    document.getElementById('loadingText').textContent = text || 'Working...';
    document.getElementById('loadingSub').textContent = sub || '';
    if (progress !== undefined) {
      document.getElementById('progressFill').style.width = progress + '%';
      // Animate to higher %
      setTimeout(() => {
        document.getElementById('progressFill').style.width = (progress + 30) + '%';
      }, 800);
    }
  } else {
    overlay.classList.remove('visible');
    btn.disabled = false;
    document.getElementById('progressFill').style.width = '100%';
    setTimeout(() => {
      document.getElementById('progressFill').style.width = '0%';
    }, 500);
  }
}

function copyNotes() {
  const content = document.getElementById('notesContent').innerText;
  navigator.clipboard.writeText(content).then(() => showToast('Copied to clipboard ‚úì'));
}

// ‚îÄ‚îÄ‚îÄ Stats Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStatsPanel() {
  if (!styleProfile) return;
  const panel = document.getElementById('statsPanel');
  const grid = document.getElementById('statsGrid');
  const lib = getLibrary();

  const statDefs = [
    { label: 'Photos uploaded', value: uploadedImages.length, cls: '' },
    { label: 'Notes saved', value: lib.length, cls: 'highlight-blue' },
    { label: 'Note style', value: (styleProfile.noteStyle || '‚Äî').replace(/-/g, ' '), cls: 'highlight-amber' },
    { label: 'Detail level', value: (styleProfile.detailLevel || '‚Äî').replace(/-/g, ' '), cls: '' },
    { label: 'Density', value: styleProfile.writingDensity || '‚Äî', cls: '' },
    { label: 'Analogies', value: styleProfile.analogyUsage || '‚Äî', cls: 'highlight-sage' },
  ];

  grid.innerHTML = statDefs.map(s => `
    <div class="stat-item">
      <span class="stat-label">${s.label}</span>
      <span class="stat-value ${s.cls}">${s.value}</span>
    </div>
  `).join('');

  panel.style.display = 'block';
}

// ‚îÄ‚îÄ‚îÄ Library ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getLibrary() {
  try { return JSON.parse(localStorage.getItem('mimicnotes_library') || '[]'); }
  catch { return []; }
}

function saveLibrary(lib) {
  localStorage.setItem('mimicnotes_library', JSON.stringify(lib));
}

function saveToLibrary() {
  const topic = document.getElementById('notesTitleDisplay').textContent;
  const content = document.getElementById('notesContent').innerHTML;
  if (!topic || topic === 'Notes' || !content) {
    showToast('‚ö† Generate notes first before saving');
    return;
  }
  const lib = getLibrary();
  // Avoid duplicate topics (update instead)
  const existingIdx = lib.findIndex(n => n.topic.toLowerCase() === topic.toLowerCase());
  const entry = { topic, content, savedAt: new Date().toISOString() };
  if (existingIdx >= 0) { lib[existingIdx] = entry; }
  else { lib.unshift(entry); }
  saveLibrary(lib);
  renderLibrary();
  updateStatsPanel();
  showToast(`"${topic}" saved to library ‚úì`);
}

function deleteFromLibrary(index) {
  const lib = getLibrary();
  lib.splice(index, 1);
  saveLibrary(lib);
  renderLibrary();
  updateStatsPanel();
}

function renderLibrary() {
  const lib = getLibrary();
  const list = document.getElementById('libraryList');
  const empty = document.getElementById('libraryEmpty');

  if (lib.length === 0) {
    list.innerHTML = '<div class="library-empty" id="libraryEmpty">No notes saved yet ‚Äî hit "Save ‚ú¶" after generating notes</div>';
    return;
  }

  list.innerHTML = lib.map((n, i) => {
    const date = new Date(n.savedAt);
    const dateStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    return `
      <div class="library-item">
        <span class="library-item-title">${escapeHtml(n.topic)}</span>
        <span class="library-item-meta">${dateStr}</span>
        <button class="library-item-del" onclick="deleteFromLibrary(${i})" title="Remove">‚úï</button>
      </div>
    `;
  }).join('');
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ What to Study Next ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchStudySuggestions() {
  const lib = getLibrary();
  if (lib.length === 0) {
    showToast('‚ö† Save some notes first, then ask for suggestions');
    return;
  }
  if (!getKey()) {
    showToast('‚ö† Enter your API key first');
    return;
  }

  const btn = document.getElementById('refreshSuggestionsBtn');
  const loading = document.getElementById('studyLoading');
  const list = document.getElementById('studyNextList');

  btn.disabled = true;
  loading.classList.add('visible');
  list.innerHTML = '';

  const topicsList = lib.map(n => `- ${n.topic}`).join('\n');

  try {
    const response = await callClaude([{
      type: 'text',
      text: `A student has already taken notes on these topics:
${topicsList}

Based on typical academic progressions, prerequisites, and related areas of study, suggest exactly 3 topics they should study next. For each suggestion, give a short reason (1‚Äì2 sentences) explaining why it's a logical next step.

Return ONLY a JSON array like:
[
  { "topic": "Topic Name", "reason": "Why this is a logical next step..." },
  { "topic": "Topic Name", "reason": "..." },
  { "topic": "Topic Name", "reason": "..." }
]`
    }]);

    const text = response.content[0].text;
    const jsonMatch = text.match(/\[[\s\S]*\]/);
    if (!jsonMatch) throw new Error('No JSON found');
    const suggestions = JSON.parse(jsonMatch[0]);

    list.innerHTML = suggestions.map(s => `
      <div class="study-card">
        <div class="study-card-topic">${escapeHtml(s.topic)}</div>
        <div class="study-card-reason">${escapeHtml(s.reason)}</div>
        <button class="btn-study-now" onclick="studyNow(${JSON.stringify(escapeHtml(s.topic))})">Study this ‚Üí</button>
      </div>
    `).join('');

    document.getElementById('studyEmpty') && (document.getElementById('studyEmpty').style.display = 'none');
  } catch(e) {
    console.error('Study suggestions error:', e);
    list.innerHTML = '<div class="library-empty">Could not load suggestions ‚Äî check your API key</div>';
  }

  loading.classList.remove('visible');
  btn.disabled = false;
}

function studyNow(topic) {
  document.getElementById('topicInput').value = topic;
  document.getElementById('topicInput').scrollIntoView({ behavior: 'smooth' });
  showToast(`Topic set to "${topic}" ‚Äî hit Generate!`);
}

// On page load, render library
window.addEventListener('load', () => {
  const saved = localStorage.getItem('mimicnotes_key');
  if (saved) document.getElementById('apiKeyInput').value = saved;
  renderLibrary();
});

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>
</body>
</html>